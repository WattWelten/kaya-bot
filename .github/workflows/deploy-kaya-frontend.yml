name: Deploy KAYA Frontend to Railway

on:
  push:
    branches:
      - main
    paths:
      - 'kaya-frontend/**'
      - '.github/workflows/deploy-kaya-frontend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup jq (für JSON-Parsing)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Deploy to Railway via REST API
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          # Railway REST API: Service-ID für kaya-frontend abrufen
          SERVICE_ID=$(curl -s -X GET \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.railway.app/v1/projects/$RAILWAY_PROJECT_ID/services" | \
            jq -r '.services[] | select(.name == "kaya-frontend") | .id')
          
          if [ -z "$SERVICE_ID" ]; then
            echo "❌ Service 'kaya-frontend' nicht gefunden"
            exit 1
          fi
          
          echo "✅ Service-ID gefunden: $SERVICE_ID"
          
          # Deployment via REST API auslösen
          curl -X POST \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.railway.app/v1/services/$SERVICE_ID/deployments" \
            -d '{"source": "github"}'
          
          echo "✅ Deployment ausgelöst für kaya-frontend"

