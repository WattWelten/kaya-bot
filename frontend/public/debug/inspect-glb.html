<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Inspect GLB (Bones & MorphTargets)</title>
  <style>html,body,#render{width:100%;height:100%;margin:0;overflow:hidden}</style>
  <!-- CDN Mirror 1: unpkg (nutze dies, wenn cdn.babylonjs.com blockiert ist) -->
  <script src="https://unpkg.com/babylonjs@6.37.1/babylon.js"></script>
  <script src="https://unpkg.com/babylonjs-loaders@6.37.1/babylonjs.loaders.min.js"></script>
  <!-- Alternative Mirrors (bei Bedarf aktivieren): -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/babylonjs@6.37.1/babylon.js"></script> -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/babylonjs-loaders@6.37.1/babylonjs.loaders.min.js"></script> -->
</head>
<body>
  <canvas id="render"></canvas>
  <script>
    const canvas = document.getElementById('render');
    const engine = new BABYLON.Engine(canvas, true);
    const scene = new BABYLON.Scene(engine);
    const camera = new BABYLON.ArcRotateCamera('cam', 0, 1.2, 2.2, BABYLON.Vector3.Zero(), scene);
    camera.attachControl(canvas, true);
    new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);

    // Pfad/Dateiname bei Bedarf anpassen
    const folder = '/avatar/';
    const file = 'Kayanew.glb';

    BABYLON.SceneLoader.Append(folder, file, scene, () => {
      console.log('âœ… GLB geladen:', file);
      console.log('Meshes:', scene.meshes.length);
      console.log('Skeletons:', scene.skeletons.length);

      // Bones listen und Mund/Kiefer/Lippe markieren
      scene.skeletons.forEach((sk, si) => {
        console.log(`Skeleton[${si}] ${sk.name} â†’ Bones: ${sk.bones.length}`);
        sk.bones.forEach(b => {
          const n = (b.name || '').toLowerCase();
          if (n.includes('jaw') || n.includes('mouth') || n.includes('lip')) {
            console.log('  ðŸ”Ž Bone:', b.name);
          }
        });
      });

      // TransformNodes prÃ¼fen
      if (scene.transformNodes) {
        scene.transformNodes.forEach(tn => {
          const n = (tn.name || '').toLowerCase();
          if (n.includes('jaw') || n.includes('mouth') || n.includes('lip')) {
            console.log('  ðŸ§© TransformNode:', tn.name);
          }
        });
      }

      // MorphTargets prÃ¼fen - Detaillierter Report
      const withMT = scene.meshes.filter(m => m.morphTargetManager);
      if (withMT.length > 0) {
        console.log('='.repeat(60));
        console.log('ðŸ“Š DETAILLIERTER MORPH TARGET REPORT');
        console.log('='.repeat(60));
        
        // Alle Meshes mit Morph Targets
        withMT.forEach((mesh, idx) => {
          const mtm = mesh.morphTargetManager;
          console.log(`\nðŸ“¦ Mesh[${idx}]: "${mesh.name}"`);
          console.log(`   Morph Targets: ${mtm.numTargets}`);
          
          const allTargets = [];
          for (let i = 0; i < mtm.numTargets; i++) {
            const t = mtm.getTarget(i);
            if (t) {
              const name = t.name || `morph_${i}`;
              allTargets.push({ name, index: i });
            }
          }
          
          // Kategorisieren
          const visemes = allTargets.filter(t => /viseme/i.test(t.name));
          const emotions = allTargets.filter(t => /(smile|frown|brow|mouth)/i.test(t.name));
          const other = allTargets.filter(t => !visemes.includes(t) && !emotions.includes(t));
          
          console.log(`\n   ðŸŽ­ Visemes (${visemes.length}):`);
          visemes.forEach(t => console.log(`      - ${t.name} (Index: ${t.index})`));
          
          console.log(`\n   ðŸ˜Š Emotion-Targets (${emotions.length}):`);
          emotions.forEach(t => console.log(`      - ${t.name} (Index: ${t.index})`));
          
          console.log(`\n   ðŸ“‹ Andere Targets (${other.length}):`);
          other.forEach(t => console.log(`      - ${t.name} (Index: ${t.index})`));
        });
        
        // Mapping-VorschlÃ¤ge
        const mainMTM = withMT[0].morphTargetManager;
        const allTargetNames = [];
        for (let i = 0; i < mainMTM.numTargets; i++) {
          const t = mainMTM.getTarget(i);
          if (t) {
            allTargetNames.push(t.name || `morph_${i}`);
          }
        }
        
        console.log('\n' + '='.repeat(60));
        console.log('ðŸ’¡ MAPPING-VORSCHLÃ„GE');
        console.log('='.repeat(60));
        
        // Viseme-Mapping
        const visemeMapping = {
          'viseme_sil': ['sil'],
          'viseme_pp': ['M', 'B', 'P'],
          'viseme_ff': ['F', 'V'],
          'viseme_th': ['TH'],
          'viseme_dd': ['D', 'T'],
          'viseme_kk': ['K', 'G'],
          'viseme_ch': ['CH', 'J'],
          'viseme_ss': ['S', 'Z'],
          'viseme_nn': ['N'],
          'viseme_rr': ['R'],
          'viseme_aa': ['aa'],
          'viseme_e': ['E', 'ee'],
          'viseme_i': ['I', 'ih'],
          'viseme_o': ['O', 'oh'],
          'viseme_u': ['U', 'ou']
        };
        
        console.log('\nðŸŽ­ Viseme-Mappings:');
        Object.keys(visemeMapping).forEach(visemeName => {
          const found = allTargetNames.find(n => n.toLowerCase() === visemeName.toLowerCase());
          if (found) {
            const mappedTo = visemeMapping[visemeName].join(', ');
            console.log(`   âœ… ${visemeName} â†’ ${mappedTo}`);
          } else {
            console.log(`   âš ï¸  ${visemeName} â†’ NICHT GEFUNDEN`);
          }
        });
        
        // Emotion-Mapping
        const emotionTargets = ['mouthSmile_L', 'mouthSmile_R', 'mouthFrown_L', 'mouthFrown_R', 
                                'browInnerUp', 'browDown_L', 'browDown_R', 'mouthOpen', 'mouthFunnel'];
        
        console.log('\nðŸ˜Š Emotion-Target-Mappings:');
        emotionTargets.forEach(emotionName => {
          const found = allTargetNames.find(n => {
            const nLower = n.toLowerCase();
            const eLower = emotionName.toLowerCase();
            return nLower === eLower || 
                   nLower.includes(eLower.replace('_l', 'left').replace('_r', 'right')) ||
                   nLower.includes(eLower.replace('left', '_l').replace('right', '_r'));
          });
          if (found) {
            console.log(`   âœ… ${emotionName} â†’ ${found}`);
          } else {
            console.log(`   âš ï¸  ${emotionName} â†’ NICHT GEFUNDEN`);
          }
        });
        
        console.log('\n' + '='.repeat(60));
        console.log(`ðŸ“‹ ALLE MORPH TARGET NAMEN (${allTargetNames.length}):`);
        console.log(allTargetNames.join(', '));
        console.log('='.repeat(60));
      } else {
        console.log('âš ï¸ Keine MorphTargets gefunden.');
      }

      engine.runRenderLoop(() => scene.render());
    }, null, (scene, msg, ex) => {
      console.error('âŒ Load-Fehler:', msg, ex);
    });

    window.addEventListener('resize', () => engine.resize());
  </script>
</body>
</html>


