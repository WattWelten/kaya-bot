var Y=Object.defineProperty;var H=(a,e,t)=>e in a?Y(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var p=(a,e,t)=>(H(a,typeof e!="symbol"?e+"":e,t),t);import{r as c,a as G,R as J}from"./react-vendor-b1791c80.js";import{C as Z,A as q,I as Q,V as X,H as ee,M as I,P as te,S as se}from"./ui-vendor-c1796c1b.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();var P={exports:{}},N={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ne=c,re=Symbol.for("react.element"),ae=Symbol.for("react.fragment"),ie=Object.prototype.hasOwnProperty,oe=ne.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,ce={key:!0,ref:!0,__self:!0,__source:!0};function M(a,e,t){var n,i={},r=null,l=null;t!==void 0&&(r=""+t),e.key!==void 0&&(r=""+e.key),e.ref!==void 0&&(l=e.ref);for(n in e)ie.call(e,n)&&!ce.hasOwnProperty(n)&&(i[n]=e[n]);if(a&&a.defaultProps)for(n in e=a.defaultProps,e)i[n]===void 0&&(i[n]=e[n]);return{$$typeof:re,type:a,key:r,ref:l,props:i,_owner:oe.current}}N.Fragment=ae;N.jsx=M;N.jsxs=M;P.exports=N;var s=P.exports,T={},O=G;T.createRoot=O.createRoot,T.hydrateRoot=O.hydrateRoot;const le=({accessibility:a,onAccessibilityChange:e,onLanguageChange:t})=>{const n=()=>{e({...a,highContrast:!a.highContrast})},i=g=>{e({...a,fontSize:g})},r=()=>{e({...a,simpleLanguage:!a.simpleLanguage})},l=g=>{t(g.target.value)};return s.jsx("header",{className:"h-16 w-full border-b border-lc-neutral-200 bg-white/90 backdrop-blur sticky top-0 z-40",children:s.jsxs("div",{className:"max-w-7xl mx-auto h-full px-4 sm:px-6 flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"h-8 w-8 rounded-xl bg-lc-primary-600","aria-hidden":"true"}),s.jsxs("div",{className:"leading-tight",children:[s.jsx("p",{className:"text-sm text-lc-neutral-500",children:"Landkreis Oldenburg"}),s.jsx("h1",{className:"text-base font-semibold tracking-tight",children:"KAYA – Service-Assistentin"})]})]}),s.jsxs("nav",{className:"flex items-center gap-2",role:"toolbar","aria-label":"Einstellungen",children:[s.jsx("button",{className:"btn-ghost","aria-pressed":a.highContrast,"aria-label":"Kontrast umschalten",onClick:n,children:s.jsx(Z,{className:"size-5"})}),s.jsxs("div",{className:"flex items-center gap-1",role:"group","aria-label":"Schriftgröße",children:[s.jsx("button",{className:`btn-ghost text-xs ${a.fontSize===100?"bg-lc-neutral-100":""}`,"aria-label":"Schrift 100%",onClick:()=>i(100),children:"A"}),s.jsx("button",{className:`btn-ghost text-sm ${a.fontSize===115?"bg-lc-neutral-100":""}`,"aria-label":"Schrift 115%",onClick:()=>i(115),children:"A+"}),s.jsx("button",{className:`btn-ghost text-base ${a.fontSize===130?"bg-lc-neutral-100":""}`,"aria-label":"Schrift 130%",onClick:()=>i(130),children:"A++"})]}),s.jsx("button",{className:"btn-ghost","aria-pressed":a.simpleLanguage,"aria-label":"Einfache Sprache umschalten",onClick:r,children:s.jsx(q,{className:"size-5"})}),s.jsxs("select",{className:"btn-ghost text-sm","aria-label":"Sprache wechseln",onChange:l,defaultValue:"de",children:[s.jsx("option",{value:"de",children:"Deutsch"}),s.jsx("option",{value:"en",children:"English"}),s.jsx("option",{value:"tr",children:"Türkçe"}),s.jsx("option",{value:"ar",children:"العربية"}),s.jsx("option",{value:"pl",children:"Polski"}),s.jsx("option",{value:"ru",children:"Русский"})]}),s.jsx("button",{className:"btn-ghost","aria-label":"Hilfe und Hinweise",onClick:()=>{console.log("Hilfe-Dialog öffnen")},children:s.jsx(Q,{className:"size-5"})})]})]})})};class de{constructor(){p(this,"unity",null);p(this,"canvas",null);p(this,"isLoaded",!1);p(this,"isLoading",!1);p(this,"loadListeners",[]);p(this,"errorListeners",[])}async initialize(e="unity-canvas"){if(!(this.isLoading||this.isLoaded)){if(this.isLoading=!0,this.canvas=document.getElementById(e),!this.canvas)throw new Error(`Canvas mit ID '${e}' nicht gefunden`);try{window.createUnityInstance||await this.loadUnityLoader();const t={dataUrl:"/unity/kaya/Build/Build.data",frameworkUrl:"/unity/kaya/Build/Build.framework.js",codeUrl:"/unity/kaya/Build/Build.wasm",streamingAssetsUrl:"/unity/kaya/StreamingAssets",companyName:"Landkreis Oldenburg",productName:"KAYA Avatar",productVersion:"2.0.0"};console.log("🎮 Unity-Instanz wird erstellt..."),this.unity=await window.createUnityInstance(this.canvas,t),this.isLoaded=!0,this.isLoading=!1,this.notifyLoadListeners(!0),console.log("✅ Unity-Instanz erfolgreich geladen"),this.sendUnityMessage({type:"emotion",data:{emotion:"neutral",intensity:.5}})}catch(t){throw this.isLoading=!1,this.notifyErrorListeners({code:"UNITY_LOAD_ERROR",message:"Unity-Instanz konnte nicht geladen werden",details:t instanceof Error?t.message:"Unbekannter Fehler",timestamp:new Date}),t}}}async loadUnityLoader(){return new Promise((e,t)=>{const n=document.createElement("script");n.src="/unity/kaya/Build/Build.loader.js",n.onload=()=>{console.log("📦 Unity Loader geladen"),e()},n.onerror=()=>{t(new Error("Unity Loader konnte nicht geladen werden"))},document.head.appendChild(n)})}sendUnityMessage(e){if(!this.unity){console.warn("⚠️ Unity-Instanz nicht verfügbar");return}try{const t=JSON.stringify(e.data);switch(e.type){case"emotion":this.unity.SendMessage("KayaController","SetEmotion",t);break;case"speaking":this.unity.SendMessage("KayaController","SetSpeaking",t);break;case"gesture":this.unity.SendMessage("KayaController","SetGesture",t);break;case"animation":this.unity.SendMessage("KayaController","PlayAnimation",t);break;default:console.warn("⚠️ Unbekannter Unity-Nachrichtentyp:",e.type)}console.log("📤 Unity-Nachricht gesendet:",e)}catch(t){console.error("❌ Unity-Nachricht Fehler:",t),this.notifyErrorListeners({code:"UNITY_MESSAGE_ERROR",message:"Nachricht an Unity fehlgeschlagen",details:t instanceof Error?t.message:"Unbekannter Fehler",timestamp:new Date})}}setEmotion(e,t=.5){this.sendUnityMessage({type:"emotion",data:{emotion:e,intensity:t}})}setSpeaking(e){this.sendUnityMessage({type:"speaking",data:{isSpeaking:e}})}playGesture(e){this.sendUnityMessage({type:"gesture",data:{gesture:e}})}playAnimation(e){this.sendUnityMessage({type:"animation",data:{animation:e}})}async quit(){if(this.unity)try{await this.unity.Quit(),this.unity=null,this.isLoaded=!1,this.notifyLoadListeners(!1),console.log("🛑 Unity-Instanz beendet")}catch(e){console.error("❌ Unity-Quit Fehler:",e)}}addLoadListener(e){this.loadListeners.push(e)}addErrorListener(e){this.errorListeners.push(e)}removeLoadListener(e){const t=this.loadListeners.indexOf(e);t>-1&&this.loadListeners.splice(t,1)}removeErrorListener(e){const t=this.errorListeners.indexOf(e);t>-1&&this.errorListeners.splice(t,1)}isUnityLoaded(){return this.isLoaded&&this.unity!==null}isUnityLoading(){return this.isLoading}notifyLoadListeners(e){this.loadListeners.forEach(t=>{try{t(e)}catch(n){console.error("❌ Load-Listener Fehler:",n)}})}notifyErrorListeners(e){this.errorListeners.forEach(t=>{try{t(e)}catch(n){console.error("❌ Error-Listener Fehler:",n)}})}}let U=null;const he=()=>(U||(U=new de),U),ue=(a="unity-canvas")=>{const[e,t]=c.useState(null),[n,i]=c.useState(!1),[r,l]=c.useState(!1),[g,b]=c.useState(null),y=c.useRef(null);c.useEffect(()=>{const u=he();y.current=u;const x=S=>{i(S),l(!1),S&&(t(u),b(null))},R=S=>{b(S),l(!1),i(!1)};return u.addLoadListener(x),u.addErrorListener(R),()=>{u.removeLoadListener(x),u.removeErrorListener(R)}},[]);const v=c.useCallback(async()=>{if(y.current&&!n&&!r){l(!0),b(null);try{await y.current.initialize(a)}catch(u){console.error("❌ Unity-Initialisierung fehlgeschlagen:",u),b({code:"INITIALIZATION_FAILED",message:"Unity-Initialisierung fehlgeschlagen",details:u instanceof Error?u.message:"Unbekannter Fehler",timestamp:new Date}),l(!1)}}},[a,n,r]),L=c.useCallback(u=>{y.current?y.current.sendUnityMessage(u):console.warn("⚠️ Unity-Service nicht verfügbar")},[]),m=c.useCallback((u,x=.5)=>{y.current&&y.current.setEmotion(u,x)},[]),o=c.useCallback(u=>{y.current&&y.current.setSpeaking(u)},[]),d=c.useCallback(u=>{y.current&&y.current.playGesture(u)},[]),f=c.useCallback(u=>{y.current&&y.current.playAnimation(u)},[]);return{unity:e,isLoaded:n,isLoading:r,sendUnityMessage:L,setEmotion:m,setSpeaking:o,playGesture:d,playAnimation:f,error:g,initialize:v}},ge=({isSpeaking:a,captionText:e,setIsSpeaking:t,onEmotionChange:n})=>{const{unity:i,isLoaded:r,isLoading:l,setEmotion:g,setSpeaking:b,playGesture:y,playAnimation:v,error:L,initialize:m}=ue("unity-canvas"),[o,d]=c.useState(!1);c.useEffect(()=>{console.log("Unity-Avatar bereit für Initialisierung"),!o&&!l&&!r&&m().then(()=>{d(!0),console.log("✅ Unity-Avatar erfolgreich initialisiert")}).catch(x=>{console.error("❌ Unity-Initialisierung fehlgeschlagen:",x),d(!0)})},[m,o,l,r]),c.useEffect(()=>{r&&(b(a),a?(g("speaking",.8),v("speaking")):(g("neutral",.5),v("idle")))},[a,r,b,g,v]),c.useEffect(()=>{n&&r&&(e.includes("Hilfe")||e.includes("Problem")?(g("concerned",.7),n("concerned",.7)):(e.includes("Danke")||e.includes("Perfekt"))&&(g("happy",.8),n("happy",.8)))},[e,n,r,g]);const f=()=>{t(!a)},u=()=>{console.log("Verlauf umschalten")};return s.jsxs("section",{"aria-label":"Avatar Bereich",className:"relative bg-gradient-to-b from-lc-neutral-100 to-lc-neutral-100 md:h-[calc(100svh-4rem)] h-[60svh] overflow-hidden",children:[s.jsxs("div",{className:"absolute inset-0",children:[l&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-lc-neutral-100",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-lc-primary-600 mx-auto mb-4"}),s.jsx("p",{className:"text-sm text-lc-neutral-600",children:"KAYA wird geladen..."})]})}),L&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-lc-neutral-100",children:s.jsxs("div",{className:"text-center p-6",children:[s.jsx("div",{className:"text-lc-neutral-400 mb-4",children:s.jsx("svg",{className:"w-16 h-16 mx-auto",fill:"currentColor",viewBox:"0 0 20 20",children:s.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})}),s.jsx("h3",{className:"text-lg font-semibold text-lc-neutral-800 mb-2",children:"Avatar nicht verfügbar"}),s.jsx("p",{className:"text-sm text-lc-neutral-600 mb-4",children:L.message}),s.jsx("button",{onClick:()=>m(),className:"btn-solid",children:"Erneut versuchen"})]})}),s.jsx("canvas",{id:"unity-canvas",className:"w-full h-full block",style:{display:r?"block":"none"}})]}),s.jsxs("div",{className:"absolute bottom-4 left-4 right-4 md:left-6 md:right-6 flex items-center justify-between",children:[s.jsx("div",{className:"px-3 py-2 rounded-2xl bg-white/75 backdrop-blur border border-white/60 shadow-soft max-w-[80%]",children:s.jsx("p",{className:"text-sm text-lc-neutral-800",children:"Moin! Ich bin KAYA. Wobei kann ich Ihnen helfen?"})}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{className:"btn-solid","aria-label":a?"Audio stoppen":"Audio vorlesen",onClick:f,children:s.jsx(X,{className:"size-5"})}),s.jsx("button",{className:"btn-ghost","aria-label":"Verlauf ausblenden",onClick:u,children:s.jsx(ee,{className:"size-5"})})]})]}),a&&s.jsx("div",{"aria-live":"polite",className:"absolute left-4 right-4 bottom-20 md:bottom-24 text-sm text-lc-neutral-800 bg-white/90 backdrop-blur rounded-xl px-3 py-2 shadow-soft",children:e||"Ich lese Ihnen die nächsten Schritte vor …"}),s.jsx("div",{className:"absolute top-4 right-4",children:s.jsx("div",{className:`px-2 py-1 rounded-full text-xs font-medium ${r?"bg-green-100 text-green-800":l?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:r?"Online":l?"Lädt...":"Offline"})})]})};class me{constructor(e){p(this,"ws",null);p(this,"sessionId");p(this,"reconnectAttempts",0);p(this,"maxReconnectAttempts",5);p(this,"reconnectDelay",1e3);p(this,"isConnecting",!1);p(this,"messageListeners",[]);p(this,"connectionListeners",[]);p(this,"errorListeners",[]);this.sessionId=e}async connect(){if(!(this.isConnecting||this.ws&&this.ws.readyState===WebSocket.OPEN)){this.isConnecting=!0;try{const e=this.getWebSocketUrl();this.ws=new WebSocket(e),this.ws.onopen=()=>{console.log("🔗 WebSocket verbunden"),this.isConnecting=!1,this.reconnectAttempts=0,this.notifyConnectionListeners(!0)},this.ws.onmessage=t=>{try{const n=JSON.parse(t.data);this.handleMessage(n)}catch(n){console.error("❌ WebSocket Nachricht-Parsing Fehler:",n),this.notifyErrorListeners({code:"PARSE_ERROR",message:"Fehler beim Verarbeiten der Nachricht",details:n instanceof Error?n.message:"Unbekannter Fehler",timestamp:new Date})}},this.ws.onclose=t=>{console.log("🔌 WebSocket geschlossen:",t.code,t.reason),this.isConnecting=!1,this.notifyConnectionListeners(!1),!t.wasClean&&this.reconnectAttempts<this.maxReconnectAttempts&&this.scheduleReconnect()},this.ws.onerror=t=>{console.error("❌ WebSocket Fehler:",t),this.isConnecting=!1,this.notifyErrorListeners({code:"WEBSOCKET_ERROR",message:"Verbindungsfehler",details:"WebSocket-Verbindung fehlgeschlagen",timestamp:new Date})}}catch(e){throw this.isConnecting=!1,this.notifyErrorListeners({code:"CONNECTION_ERROR",message:"Verbindung fehlgeschlagen",details:e instanceof Error?e.message:"Unbekannter Fehler",timestamp:new Date}),e}}}sendMessage(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.warn("⚠️ WebSocket nicht verbunden");return}const t={type:"message",sessionId:this.sessionId,data:{message:e,timestamp:new Date().toISOString(),type:"text"},timestamp:new Date};this.ws.send(JSON.stringify(t))}sendAudioMessage(e,t="audio/wav"){if(!this.ws||this.ws.readyState!==WebSocket.OPEN){console.warn("⚠️ WebSocket nicht verbunden");return}const n={type:"message",sessionId:this.sessionId,data:{message:e,type:"audio",format:t,timestamp:new Date().toISOString()},timestamp:new Date};this.ws.send(JSON.stringify(n))}disconnect(){this.ws&&(this.ws.close(1e3,"Client disconnect"),this.ws=null)}addMessageListener(e){this.messageListeners.push(e)}addConnectionListener(e){this.connectionListeners.push(e)}addErrorListener(e){this.errorListeners.push(e)}removeMessageListener(e){const t=this.messageListeners.indexOf(e);t>-1&&this.messageListeners.splice(t,1)}removeConnectionListener(e){const t=this.connectionListeners.indexOf(e);t>-1&&this.connectionListeners.splice(t,1)}removeErrorListener(e){const t=this.errorListeners.indexOf(e);t>-1&&this.errorListeners.splice(t,1)}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}getWebSocketUrl(){return`wss://api.kaya.wattweiser.com/ws?sessionId=${this.sessionId}`}handleMessage(e){console.log("📨 WebSocket Nachricht erhalten:",e),this.notifyMessageListeners(e)}scheduleReconnect(){this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log(`🔄 Reconnect in ${e}ms (Versuch ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),setTimeout(()=>{this.connect().catch(t=>{console.error("❌ Reconnect fehlgeschlagen:",t)})},e)}notifyMessageListeners(e){this.messageListeners.forEach(t=>{try{t(e)}catch(n){console.error("❌ Message-Listener Fehler:",n)}})}notifyConnectionListeners(e){this.connectionListeners.forEach(t=>{try{t(e)}catch(n){console.error("❌ Connection-Listener Fehler:",n)}})}notifyErrorListeners(e){this.errorListeners.forEach(t=>{try{t(e)}catch(n){console.error("❌ Error-Listener Fehler:",n)}})}}let k=null;const fe=a=>((!k||a&&k.sessionId!==a)&&(k&&k.disconnect(),k=new me(a||pe())),k);function pe(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const ye=a=>{const[e,t]=c.useState(!1),[n,i]=c.useState(null),[r,l]=c.useState(null),g=c.useRef(null),b=c.useRef(null);c.useEffect(()=>{const m=fe(a);g.current=m;const o=u=>{i(u),l(null)},d=u=>{t(u),u&&l(null)},f=u=>{l(u),t(!1)};return m.addMessageListener(o),m.addConnectionListener(d),m.addErrorListener(f),m.connect().catch(u=>{console.error("❌ WebSocket Verbindung fehlgeschlagen:",u),l({code:"CONNECTION_FAILED",message:"Verbindung zum Server fehlgeschlagen",details:u instanceof Error?u.message:"Unbekannter Fehler",timestamp:new Date})}),()=>{m.removeMessageListener(o),m.removeConnectionListener(d),m.removeErrorListener(f),b.current&&clearTimeout(b.current)}},[a]);const y=c.useCallback(m=>{g.current?g.current.sendMessage(m):console.warn("⚠️ WebSocket-Service nicht verfügbar")},[]),v=c.useCallback((m,o="audio/wav")=>{g.current?g.current.sendAudioMessage(m,o):console.warn("⚠️ WebSocket-Service nicht verfügbar")},[]),L=c.useCallback(()=>{g.current&&(g.current.disconnect(),g.current.connect().catch(m=>{console.error("❌ Reconnect fehlgeschlagen:",m),l({code:"RECONNECT_FAILED",message:"Wiederverbindung fehlgeschlagen",details:m instanceof Error?m.message:"Unbekannter Fehler",timestamp:new Date})}))},[]);return{isConnected:e,sendMessage:y,sendAudioMessage:v,lastMessage:n,error:r,reconnect:L}};class be{constructor(){p(this,"mediaRecorder",null);p(this,"audioContext",null);p(this,"audioChunks",[]);p(this,"isRecording",!1);p(this,"isPlaying",!1);p(this,"currentAudio",null);p(this,"recordingListeners",[]);p(this,"playingListeners",[]);p(this,"errorListeners",[]);p(this,"recordedAudioBlob",null)}async startRecording(){if(!this.isRecording)try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:44100}});this.audioContext=new AudioContext,this.audioChunks=[],this.mediaRecorder=new MediaRecorder(e,{mimeType:"audio/webm;codecs=opus"}),this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&this.audioChunks.push(t.data)},this.mediaRecorder.onstop=()=>{const t=new Blob(this.audioChunks,{type:"audio/webm"});this.handleRecordingComplete(t),e.getTracks().forEach(n=>n.stop())},this.mediaRecorder.start(100),this.isRecording=!0,this.notifyRecordingListeners(!0),console.log("🎤 Audio-Aufnahme gestartet")}catch(e){throw console.error("❌ Audio-Aufnahme Fehler:",e),this.notifyErrorListeners({code:"RECORDING_ERROR",message:"Audio-Aufnahme fehlgeschlagen",details:e instanceof Error?e.message:"Unbekannter Fehler",timestamp:new Date}),e}}stopRecording(){!this.isRecording||!this.mediaRecorder||(this.mediaRecorder.stop(),this.isRecording=!1,this.notifyRecordingListeners(!1),console.log("🛑 Audio-Aufnahme gestoppt"))}async playAudio(e){this.isPlaying&&this.stopAudio();try{this.currentAudio=new Audio(e),this.currentAudio.onplay=()=>{this.isPlaying=!0,this.notifyPlayingListeners(!0)},this.currentAudio.onended=()=>{this.isPlaying=!1,this.notifyPlayingListeners(!1),this.currentAudio=null},this.currentAudio.onerror=()=>{this.isPlaying=!1,this.notifyPlayingListeners(!1),this.notifyErrorListeners({code:"PLAYBACK_ERROR",message:"Audio-Wiedergabe fehlgeschlagen",details:"Audio-Datei konnte nicht abgespielt werden",timestamp:new Date})},await this.currentAudio.play(),console.log("🔊 Audio-Wiedergabe gestartet")}catch(t){throw console.error("❌ Audio-Wiedergabe Fehler:",t),this.notifyErrorListeners({code:"PLAYBACK_ERROR",message:"Audio-Wiedergabe fehlgeschlagen",details:t instanceof Error?t.message:"Unbekannter Fehler",timestamp:new Date}),t}}stopAudio(){this.currentAudio&&(this.currentAudio.pause(),this.currentAudio.currentTime=0,this.currentAudio=null),this.isPlaying=!1,this.notifyPlayingListeners(!1)}async textToSpeech(e,t="de-DE"){try{return"speechSynthesis"in window?this.webSpeechTTS(e,t):this.serverTTS(e,t)}catch(n){throw console.error("❌ TTS Fehler:",n),this.notifyErrorListeners({code:"TTS_ERROR",message:"Text-zu-Sprache Konvertierung fehlgeschlagen",details:n instanceof Error?n.message:"Unbekannter Fehler",timestamp:new Date}),n}}async webSpeechTTS(e,t){return new Promise((n,i)=>{const r=new SpeechSynthesisUtterance(e);r.lang=t,r.rate=.9,r.pitch=1,r.volume=1,r.onend=()=>{n("web-speech-completed")},r.onerror=l=>{i(new Error(`Web Speech TTS Fehler: ${l.error}`))},speechSynthesis.speak(r)})}async serverTTS(e,t){const n=await fetch("/api/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,language:t,voice:"kaya"})});if(!n.ok)throw new Error(`TTS Server Fehler: ${n.status}`);const i=await n.blob();return URL.createObjectURL(i)}async speechToText(e){try{const t=new FormData;t.append("audio",e,"recording.webm"),t.append("language","de-DE");const i=await fetch("https://api.kaya.wattweiser.com/api/stt",{method:"POST",body:t});if(!i.ok)throw new Error(`STT Server Fehler: ${i.status}`);return(await i.json()).text}catch(t){throw console.error("❌ STT Fehler:",t),this.notifyErrorListeners({code:"STT_ERROR",message:"Sprache-zu-Text Konvertierung fehlgeschlagen",details:t instanceof Error?t.message:"Unbekannter Fehler",timestamp:new Date}),t}}async audioChat(e){try{const t=new FormData;t.append("audio",e,"recording.webm");const n="https://api.kaya.wattweiser.com/api/audio-chat";console.log("🎙️ Sende Audio-Chat Request...");const i=await fetch(n,{method:"POST",body:t});if(!i.ok)throw new Error(`Audio-Chat Server Fehler: ${i.status}`);const r=await i.json();return console.log("✅ Audio-Chat Response erhalten:",r),{transcription:r.transcription,response:r.response,audioUrl:r.audioUrl}}catch(t){throw console.error("❌ Audio-Chat Fehler:",t),this.notifyErrorListeners({code:"AUDIO_CHAT_ERROR",message:"Audio-Chat fehlgeschlagen",details:t instanceof Error?t.message:"Unbekannter Fehler",timestamp:new Date}),t}}async audioToBase64(e){return new Promise((t,n)=>{const i=new FileReader;i.onload=()=>{const r=i.result;t(r.split(",")[1])},i.onerror=()=>{n(new Error("Audio zu Base64 Konvertierung fehlgeschlagen"))},i.readAsDataURL(e)})}handleRecordingComplete(e){console.log("📹 Audio-Aufnahme abgeschlossen:",e.size,"bytes"),this.recordedAudioBlob=e}getRecordedAudio(){return this.recordedAudioBlob}clearRecordedAudio(){this.recordedAudioBlob=null}addRecordingListener(e){this.recordingListeners.push(e)}addPlayingListener(e){this.playingListeners.push(e)}addErrorListener(e){this.errorListeners.push(e)}removeRecordingListener(e){const t=this.recordingListeners.indexOf(e);t>-1&&this.recordingListeners.splice(t,1)}removePlayingListener(e){const t=this.playingListeners.indexOf(e);t>-1&&this.playingListeners.splice(t,1)}removeErrorListener(e){const t=this.errorListeners.indexOf(e);t>-1&&this.errorListeners.splice(t,1)}isCurrentlyRecording(){return this.isRecording}isCurrentlyPlaying(){return this.isPlaying}notifyRecordingListeners(e){this.recordingListeners.forEach(t=>{try{t(e)}catch(n){console.error("❌ Recording-Listener Fehler:",n)}})}notifyPlayingListeners(e){this.playingListeners.forEach(t=>{try{t(e)}catch(n){console.error("❌ Playing-Listener Fehler:",n)}})}notifyErrorListeners(e){this.errorListeners.forEach(t=>{try{t(e)}catch(n){console.error("❌ Error-Listener Fehler:",n)}})}}let D=null;const F=()=>(D||(D=new be),D),xe=()=>{const[a,e]=c.useState(!1),[t,n]=c.useState(!1),[i,r]=c.useState(null),l=c.useRef(null);c.useEffect(()=>{const o=F();l.current=o;const d=x=>{e(x)},f=x=>{n(x)},u=x=>{r(x)};return o.addRecordingListener(d),o.addPlayingListener(f),o.addErrorListener(u),()=>{o.removeRecordingListener(d),o.removePlayingListener(f),o.removeErrorListener(u)}},[]);const g=c.useCallback(async()=>{if(l.current)try{await l.current.startRecording(),r(null)}catch(o){console.error("❌ Aufnahme-Start fehlgeschlagen:",o),r({code:"RECORDING_START_FAILED",message:"Aufnahme konnte nicht gestartet werden",details:o instanceof Error?o.message:"Unbekannter Fehler",timestamp:new Date})}},[]),b=c.useCallback(()=>{l.current&&l.current.stopRecording()},[]),y=c.useCallback(async o=>{if(l.current)try{await l.current.playAudio(o),r(null)}catch(d){console.error("❌ Audio-Wiedergabe fehlgeschlagen:",d),r({code:"PLAYBACK_FAILED",message:"Audio konnte nicht abgespielt werden",details:d instanceof Error?d.message:"Unbekannter Fehler",timestamp:new Date})}},[]),v=c.useCallback(()=>{l.current&&l.current.stopAudio()},[]),L=c.useCallback(async(o,d="de-DE")=>{if(l.current)try{const f=await l.current.textToSpeech(o,d);return r(null),f}catch(f){throw console.error("❌ TTS fehlgeschlagen:",f),r({code:"TTS_FAILED",message:"Text-zu-Sprache Konvertierung fehlgeschlagen",details:f instanceof Error?f.message:"Unbekannter Fehler",timestamp:new Date}),f}throw new Error("Audio-Service nicht verfügbar")},[]),m=c.useCallback(async o=>{if(l.current)try{const d=await l.current.speechToText(o);return r(null),d}catch(d){throw console.error("❌ STT fehlgeschlagen:",d),r({code:"STT_FAILED",message:"Sprache-zu-Text Konvertierung fehlgeschlagen",details:d instanceof Error?d.message:"Unbekannter Fehler",timestamp:new Date}),d}throw new Error("Audio-Service nicht verfügbar")},[]);return{isRecording:a,isPlaying:t,startRecording:g,stopRecording:b,playAudio:y,stopAudio:v,textToSpeech:L,speechToText:m,error:i}},we=({setCaptionText:a,onMessageSend:e})=>{const[t,n]=c.useState([{id:"1",content:"Moin! Ich bin KAYA, der digitale Assistent des Landkreises Oldenburg. Wobei kann ich Ihnen helfen?",sender:"assistant",timestamp:new Date,metadata:{emotion:"friendly",urgency:"normal",persona:"general",language:"de"}}]),[i,r]=c.useState(""),[l,g]=c.useState(!1),[b]=c.useState(()=>`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),y=c.useRef(null),v=c.useRef(null),{isConnected:L,sendMessage:m,sendAudioMessage:o,lastMessage:d,error:f}=ye(b),{isRecording:u,startRecording:x,stopRecording:R,textToSpeech:S}=xe();c.useEffect(()=>{var h;(h=y.current)==null||h.scrollIntoView({behavior:"smooth"})},[t]),c.useEffect(()=>{if(d&&d.type==="response"){const h={id:`msg_${Date.now()}`,content:d.data.response||"Antwort erhalten",sender:"assistant",timestamp:new Date,metadata:d.data.metadata};n(w=>[...w,h]),g(!1),d.data.audio&&a(h.content)}},[d,a]),c.useEffect(()=>{if(f){const h={id:`error_${Date.now()}`,content:`Entschuldigung, es ist ein Fehler aufgetreten: ${f.message}`,sender:"assistant",timestamp:new Date,metadata:{emotion:"concerned",urgency:"high",persona:"system",language:"de"}};n(w=>[...w,h]),g(!1)}},[f]);const j=async h=>{if(!h.trim()||l)return;const w={id:`msg_${Date.now()}`,content:h.trim(),sender:"user",timestamp:new Date};n(A=>[...A,w]),r(""),g(!0),m(h.trim()),e&&e(h.trim())},_=async()=>{if(u){R(),g(!0);try{const h=F(),w=h.getRecordedAudio();if(!w)throw new Error("Kein Audio vorhanden");console.log("🎙️ Starte Audio-Chat Processing...");const A=new FormData;A.append("audio",w,"recording.webm");const C=await fetch("https://api.kaya.wattweiser.com/api/audio-chat",{method:"POST",body:A});if(!C.ok)throw new Error(`Audio-Chat Fehler: ${C.status}`);const E=await C.json();console.log("✅ Audio-Chat Response:",E);const W={id:`msg_${Date.now()}`,content:E.transcription,sender:"user",timestamp:new Date},B={id:`msg_${Date.now()+1}`,content:E.response,sender:"assistant",timestamp:new Date,metadata:{emotion:"friendly",urgency:"normal",persona:"general",language:"de"}};n(V=>[...V,W,B]),E.audioUrl&&await S(E.response),h.clearRecordedAudio(),a(E.response)}catch(h){console.error("❌ Audio-Chat fehlgeschlagen:",h);const w={id:`error_${Date.now()}`,content:`Entschuldigung, Audio-Verarbeitung fehlgeschlagen: ${h instanceof Error?h.message:"Unbekannter Fehler"}`,sender:"assistant",timestamp:new Date,metadata:{emotion:"concerned",urgency:"high",persona:"system",language:"de"}};n(A=>[...A,w])}finally{g(!1)}}else try{await x()}catch(h){console.error("❌ Audio-Aufnahme fehlgeschlagen:",h)}},z=h=>{r(h.target.value);const w=h.target;w.style.height="auto",w.style.height=`${Math.min(w.scrollHeight,120)}px`},K=h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),j(i))},$=[{id:"kfz",label:"KFZ",description:"Fahrzeug-Zulassung"},{id:"meldebescheinigung",label:"Meldebescheinigung",description:"Wohnsitz-Nachweis"},{id:"wohngeld",label:"Wohngeld",description:"Wohnkosten-Zuschuss"},{id:"termin",label:"Termin",description:"Terminvereinbarung"},{id:"stellen",label:"Stellen",description:"Job-Angebote"},{id:"kreistag",label:"Kreistag",description:"Politik & Verwaltung"}];return s.jsxs("section",{id:"chat-root","aria-label":"Chat Bereich",className:"relative bg-white md:h-[calc(100svh-4rem)] h-[80svh] md:overflow-visible overflow-hidden",children:[s.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-0 w-[20vw] max-w-[20%] bg-gradient-to-l from-white to-transparent"}),s.jsxs("div",{className:"h-full flex flex-col pr-[5vw] md:mr-[-20vw] mr-[-20%]",children:[s.jsx("div",{className:"px-4 sm:px-6 py-3 border-b border-lc-neutral-200 bg-white/75 backdrop-blur sticky top-0 z-10",children:s.jsxs("div",{className:"flex items-baseline justify-between",children:[s.jsx("h2",{className:"text-sm font-semibold tracking-wide text-lc-neutral-700 uppercase",children:"Chat"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:`w-2 h-2 rounded-full ${L?"bg-green-500":"bg-red-500"}`}),s.jsx("p",{className:"text-xs text-lc-neutral-500",children:L?"Verbunden":"Getrennt"})]})]})}),s.jsx("div",{className:"px-4 sm:px-6 py-3 flex flex-wrap gap-2 border-b border-lc-neutral-100 bg-white/60",children:$.map(h=>s.jsx("button",{className:"chip-link","aria-label":`Schnellstart ${h.label}`,onClick:()=>j(h.label),children:h.label},h.id))}),s.jsxs("div",{className:"flex-1 overflow-y-auto px-4 sm:px-6 py-4 space-y-4",children:[t.map(h=>s.jsx("div",{className:`flex ${h.sender==="user"?"justify-end":"justify-start"}`,children:s.jsxs("div",{className:`max-w-[70ch] md:max-w-[62ch] rounded-2xl px-4 py-3 shadow-sm ${h.sender==="user"?"bg-lc-neutral-900 text-white":"bg-lc-primary-50 border border-lc-primary-200 text-lc-neutral-900"}`,children:[s.jsx("p",{className:"text-sm leading-relaxed",children:h.content}),h.metadata&&s.jsxs("div",{className:"mt-2 text-xs opacity-70",children:[h.metadata.emotion&&s.jsxs("span",{className:"mr-2",children:["Emotion: ",h.metadata.emotion]}),h.metadata.urgency&&s.jsxs("span",{children:["Dringlichkeit: ",h.metadata.urgency]})]})]})},h.id)),l&&s.jsx("div",{className:"flex justify-start",children:s.jsx("div",{className:"max-w-[70ch] md:max-w-[62ch] rounded-2xl px-4 py-3 bg-lc-primary-50 border border-lc-primary-200",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-lc-primary-600"}),s.jsx("p",{className:"text-sm text-lc-neutral-600",children:"KAYA denkt nach..."})]})})}),s.jsx("div",{ref:y})]}),s.jsxs("div",{className:"px-4 sm:px-6 py-4 border-t border-lc-neutral-200 bg-white/90 backdrop-blur sticky bottom-0",children:[s.jsxs("form",{onSubmit:h=>{h.preventDefault(),j(i)},className:"flex items-end gap-2","aria-label":"Nachricht verfassen",children:[s.jsx("button",{type:"button",className:`btn-ghost ${u?"bg-red-100 text-red-600 animate-pulse":""} ${l?"opacity-50 cursor-not-allowed":""}`,"aria-label":u?"Aufnahme stoppen":"Diktieren starten",onClick:_,disabled:l,title:u?"Aufnahme läuft... (Klicken zum Stoppen)":"Mikrofon aktivieren",children:u?s.jsxs("div",{className:"relative",children:[s.jsx(I,{className:"size-5"}),s.jsx("span",{className:"absolute inset-0 bg-red-500 rounded-full opacity-20 animate-ping"})]}):s.jsx(I,{className:"size-5"})}),s.jsx("label",{className:"sr-only",htmlFor:"message",children:"Nachricht"}),s.jsx("textarea",{id:"message",ref:v,value:i,onChange:z,onKeyPress:K,rows:1,placeholder:"Fragen Sie z. B.: 'KFZ ummelden – welche Unterlagen?'",className:"flex-1 resize-none rounded-2xl border border-lc-neutral-300 px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-lc-accent-600/60",disabled:l}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{type:"button",className:"btn-ghost","aria-label":"Datei anhängen",onClick:()=>{console.log("Datei-Upload")},children:s.jsx(te,{className:"size-5"})}),s.jsx("button",{type:"submit",className:"btn-solid","aria-label":"Senden",disabled:!i.trim()||l,children:s.jsx(se,{className:"size-5"})})]})]}),s.jsx("p",{className:"mt-2 text-[11px] text-lc-neutral-600",children:"Hinweis: KAYA nutzt öffentliche Informationen des Landkreises Oldenburg. Keine Rechtsberatung – Notfälle: 112 / 110."})]})]})]})};function ve(){const[a,e]=c.useState({highContrast:!1,fontSize:100,simpleLanguage:!1,reducedMotion:!1,screenReader:!1}),[t,n]=c.useState({language:"de",theme:"light",notifications:!0,accessibility:a,audio:{enabled:!0,volume:1,language:"de-DE"}}),[i,r]=c.useState(!1),[l,g]=c.useState(""),b=o=>{e(o),n(d=>({...d,accessibility:o}))},y=o=>{n(d=>({...d,language:o,audio:{...d.audio,language:o==="de"?"de-DE":"en-US"}}))},v=(o,d)=>{console.log("🎭 Avatar-Emotion geändert:",o,d)},L=o=>{console.log("📤 Nachricht gesendet:",o)},m=()=>{const o=["min-h-[100svh] bg-lc-neutral-50 text-lc-neutral-800"];return a.highContrast&&o.push("contrast-125"),a.fontSize===115?o.push("text-[1.03rem]"):a.fontSize===130&&o.push("text-[1.1rem]"),a.simpleLanguage&&o.push("simple-language"),a.reducedMotion&&o.push("reduce-motion"),o.join(" ")};return c.useEffect(()=>{const o=document.documentElement;t.theme==="dark"?o.classList.add("dark"):o.classList.remove("dark"),a.reducedMotion?(o.style.setProperty("--animation-duration","0.01ms"),o.style.setProperty("--animation-iteration-count","1")):(o.style.removeProperty("--animation-duration"),o.style.removeProperty("--animation-iteration-count"))},[t.theme,a.reducedMotion]),c.useEffect(()=>{const o=d=>{if(d.key==="Escape"&&i&&r(!1),d.altKey&&d.key==="s"){d.preventDefault();const f=document.getElementById("chat-root");f&&(f.focus(),f.scrollIntoView({behavior:"smooth"}))}if(d.altKey&&d.key==="a"){d.preventDefault();const f=document.getElementById("unity-canvas");f&&f.focus()}};return document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)},[i]),s.jsxs("div",{className:m(),children:[s.jsx("a",{href:"#chat-root",className:"skiplink","aria-label":"Zum Chat-Bereich springen",children:"Zum Chat springen"}),s.jsx(le,{accessibility:a,onAccessibilityChange:b,onLanguageChange:y}),s.jsxs("main",{className:"grid md:grid-cols-2 grid-cols-1 min-h-[calc(100svh-4rem)]",role:"main","aria-label":"KAYA Chat-Interface",children:[s.jsx(ge,{isSpeaking:i,captionText:l,setIsSpeaking:r,onEmotionChange:v}),s.jsx(we,{setCaptionText:g,onMessageSend:L})]}),a.screenReader&&s.jsx("div",{className:"sr-only","aria-live":"polite","aria-atomic":"true",children:s.jsxs("p",{children:["KAYA Chat-Interface geladen.",i?"KAYA spricht gerade.":"KAYA ist bereit für Ihre Fragen.",a.highContrast?" Hoher Kontrast aktiviert.":"",a.simpleLanguage?" Einfache Sprache aktiviert.":"","Schriftgröße: ",a.fontSize,"%."]})}),!1]})}function Le(){return s.jsx("div",{className:"App",children:s.jsx(ve,{})})}T.createRoot(document.getElementById("root")).render(s.jsx(J.StrictMode,{children:s.jsx(Le,{})}));
